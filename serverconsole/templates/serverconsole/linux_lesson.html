{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ lesson.title }} | {{ path.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  />

  <style>
    body {
      background:#020617;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      padding:2rem;
    }

    .page-shell {
      max-width: 1120px;
      margin: 0 auto;
    }

    .crumb-link {
      font-size: .82rem;
      color:#9ca3af;
      text-decoration:none;
    }
    .crumb-link:hover {
      color:#e5e7eb;
    }

    .lesson-card {
      background:#020617;
      border-radius:1rem;
      border:1px solid rgba(148,163,184,.4);
      padding:1.25rem 1.5rem;
      margin-bottom:1.25rem;
    }

    .lesson-pill {
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      font-size:.75rem;
      padding:.25rem .7rem;
      border-radius:999px;
      border:1px solid rgba(96,165,250,.5);
      background:rgba(30,64,175,.35);
      color:#bfdbfe;
    }

    .meta-label {
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#9ca3af;
    }

    .meta-value {
      font-size:.88rem;
      color:#e5e7eb;
    }

    .task-card {
      background:#020617;
      border-radius:.9rem;
      border:1px solid rgba(148,163,184,.45);
      padding:1rem 1.25rem;
      margin-bottom:.8rem;
      position:relative;
      overflow:hidden;
    }

    .task-index {
      width:28px;
      height:28px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.8rem;
      font-weight:600;
      background:rgba(37,99,235,.15);
      color:#bfdbfe;
      margin-right:.6rem;
    }

    .status-pill {
      font-size:.75rem;
      border-radius:999px;
      padding:2px 9px;
      border:1px solid transparent;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .status-pending {
      background:rgba(148,163,184,.15);
      color:#e5e7eb;
      border-color:rgba(148,163,184,.35);
    }
    .status-checking {
      background:rgba(234,179,8,.15);
      color:#facc15;
      border-color:rgba(234,179,8,.5);
    }
    .status-ok {
      background:rgba(22,163,74,.18);
      color:#bbf7d0;
      border-color:rgba(22,163,74,.7);
    }
    .status-fail {
      background:rgba(220,38,38,.18);
      color:#fecaca;
      border-color:rgba(220,38,38,.7);
    }
    .status-info {
      background:rgba(59,130,246,.18);
      color:#bfdbfe;
      border-color:rgba(59,130,246,.7);
    }

    .check-type-chip {
      font-size:.7rem;
      border-radius:999px;
      padding:2px 8px;
      background:rgba(15,23,42,1);
      border:1px solid rgba(148,163,184,.4);
      color:#9ca3af;
    }

    code {
      color:#f97316;
      font-size:.9rem;
    }

    .side-card {
      background:#020617;
      border-radius:1rem;
      border:1px solid rgba(148,163,184,.4);
      padding:1rem 1.25rem;
      font-size:.86rem;
    }

    .terminal-hint {
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.78rem;
      background:#020617;
      border-radius:.6rem;
      border:1px solid rgba(148,163,184,.4);
      padding:.75rem .9rem;
      color:#e5e7eb;
    }

    .terminal-hint .prompt {
      color:#4ade80;
    }

    .terminal-hint .command {
      color:#e5e7eb;
    }

    @media (max-width: 768px) {
      body {
        padding:1.25rem;
      }
      .lesson-card {
        padding:1rem 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="page-shell">

    <!-- Breadcrumb -->
    <div class="mb-3 d-flex align-items-center gap-2">
      <a href="{% url 'serverconsole:linux-path' %}" class="crumb-link">
        <i class="bi bi-arrow-left-short"></i> Back to Linux path
      </a>
      <span style="font-size:.8rem; color:#4b5563;">/</span>
      <span style="font-size:.8rem; color:#9ca3af;">{{ level.title }}</span>
    </div>

    <!-- Lesson header -->
    <div class="lesson-card mb-4">
      <div class="d-flex justify-content-between flex-wrap gap-3 mb-2">
        <div>
          <div class="lesson-pill mb-2">
            <i class="bi bi-terminal"></i>
            <span>Linux Practice Lesson</span>
          </div>
          <h1 class="h4 mb-1">{{ lesson.title }}</h1>
          <p class="text-white mb-0" style="font-size:.9rem;">
            {{ lesson.goal }}
          </p>
        </div>
        <div class="text-md-end">
          <div class="meta-label mb-1">Part of</div>
          <div class="meta-value mb-2">{{ level.title }}</div>
          <div class="d-flex flex-wrap justify-content-md-end gap-2">
            <a href="{% url 'serverconsole:console' %}" class="btn btn-success btn-sm">
              <i class="bi bi-play-fill me-1"></i> Open Live Terminal
            </a>
            <a href="{% url 'serverconsole:linux-leaderboard' %}" class="btn btn-outline-light btn-sm">
              <i class="bi bi-trophy me-1"></i> View Leaderboard
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Left: Tasks -->
      <div class="col-lg-7">
        <h2 class="h6 mb-3">Tasks for this lesson</h2>
        {% csrf_token %}
        {% for task in lesson.tasks %}
          <div class="task-card" id="task-{{ task.id }}">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <div class="d-flex align-items-center">
                <div class="task-index">{{ forloop.counter }}</div>
                <div class="fw-semibold">{{ task.title }}</div>
              </div>
              <span class="status-pill status-pending" data-status="pending">
                <i class="bi bi-hourglass"></i>
                <span>Pending</span>
              </span>
            </div>

            <p class="mb-2" style="font-size:.9rem;">{{ task.instruction|linebreaksbr }}</p>

            <div class="d-flex flex-wrap align-items-center gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-light"
                onclick="checkTask('{{ task.id }}')"
              >
                <i class="bi bi-check2-circle me-1"></i> Check task
              </button>

              {% if task.check_type == 'manual' %}
                <span class="check-type-chip">
                  <i class="bi bi-lightbulb"></i> Practice only
                </span>
              {% else %}
                <span class="check-type-chip">
                  <i class="bi bi-cpu"></i> Auto-check: {{ task.check_type }}
                </span>
              {% endif %}
            </div>
          </div>
        {% endfor %}

        <div class="mt-4 d-flex flex-wrap gap-2">
          <a href="{% url 'serverconsole:console' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-terminal me-1"></i> Open Terminal to Practice
          </a>
          <a href="{% url 'serverconsole:linux-path' %}" class="btn btn-outline-light btn-sm">
            Back to All Lessons
          </a>
        </div>
      </div>

      <!-- Right: Side info -->
      <div class="col-lg-5">
        <div class="side-card mb-3">
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-info-circle me-2"></i>
            <span class="fw-semibold" style="font-size:.9rem;">How to use this lesson</span>
          </div>
          <ol class="ps-3 mb-2" style="font-size:.85rem;">
            <li>Open the live terminal in another tab or window.</li>
            <li>Follow each task in order, running commands in the terminal.</li>
            <li>Click <strong>“Check task”</strong> to see if it passes (for auto-check tasks).</li>
          </ol>
          <p class="text-white mb-1" style="font-size:.8rem;">
            You can repeat tasks as many times as you like — this is a safe sandbox.
          </p>
          <p class="text-muted mb-0" style="font-size:.78rem;">
            Each completed task helps your score on the leaderboard.
          </p>
        </div>

        <div class="side-card">
          <div class="mb-2" style="font-size:.86rem; font-weight:600;">
            Example session
          </div>
          <div class="terminal-hint">
            <div><span class="prompt">student@lab</span>:<span class="command">~$</span> <span class="command">pwd</span></div>
            <div>/app</div>
            <div class="mt-1"><span class="prompt">student@lab</span>:<span class="command">~$</span> <span class="command">ls</span></div>
            <div>practice.txt  notes/</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function setStatusPill(pill, state, text) {
      pill.className = 'status-pill';
      if (state === 'checking') {
        pill.classList.add('status-checking');
        pill.innerHTML = '<i class="bi bi-arrow-repeat"></i><span>' + text + '</span>';
      } else if (state === 'ok') {
        pill.classList.add('status-ok');
        pill.innerHTML = '<i class="bi bi-check-circle"></i><span>' + text + '</span>';
      } else if (state === 'fail') {
        pill.classList.add('status-fail');
        pill.innerHTML = '<i class="bi bi-x-circle"></i><span>' + text + '</span>';
      } else if (state === 'info') {
        pill.classList.add('status-info');
        pill.innerHTML = '<i class="bi bi-lightbulb"></i><span>' + text + '</span>';
      } else {
        pill.classList.add('status-pending');
        pill.innerHTML = '<i class="bi bi-hourglass"></i><span>' + text + '</span>';
      }
    }

    async function checkTask(taskId) {
      const card = document.getElementById(`task-${taskId}`);
      const pill = card.querySelector('.status-pill');

      setStatusPill(pill, 'checking', 'Checking...');

      try {
        const resp = await fetch(
          `{% url 'serverconsole:check-task' 'TASK_ID_PLACEHOLDER' %}`.replace('TASK_ID_PLACEHOLDER', taskId),
          {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
            },
          }
        );

        const data = await resp.json();

        if (data.manual) {
          setStatusPill(pill, 'info', 'Practice task');
          return;
        }

        if (data.ok) {
          setStatusPill(pill, 'ok', 'Completed');
        } else {
          setStatusPill(pill, 'fail', 'Not yet');
          if (data.details) {
            alert('Check failed: ' + data.details);
          }
        }
      } catch (err) {
        console.error(err);
        setStatusPill(pill, 'fail', 'Error');
      }
    }
  </script>
</body>
</html>
