{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>CmdPanel Terminal</title>
  <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" rel="stylesheet" />

  <style>
    body{
      background:#020617;
      color:#fff;
      font-family:monospace;
      padding:2rem;
    }
    #terminal{
      width:100%;
      height:500px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      padding:.75rem;
    }
  </style>
</head>
<body>

<h3>WebSocket Terminal</h3>
<p>You're connected to an interactive bash shell over WebSockets.</p>

<div id="terminal"></div>

<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

<script>
  const term = new Terminal({
    cursorBlink: true,
    fontSize: 14,
    theme: {
      background: "#020617",
      foreground: "#e5e7eb"
    }
  });

  const fitAddon = new FitAddon.FitAddon();
  term.loadAddon(fitAddon);

  term.open(document.getElementById("terminal"));
  fitAddon.fit();

  // ------------------
  // WebSocket Init
  // ------------------
  const protocol = location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(`${protocol}://${location.host}/ws/terminal/`);

  socket.onopen = () => {
    term.writeln("Connected to shell.");
  };

  socket.onmessage = (e) => {
    term.write(e.data);
  };

  socket.onerror = () => {
    term.writeln("\r\n[WebSocket error]");
  };

  socket.onclose = () => {
    term.writeln("\r\n[Connection closed]");
  };

  // ------------------
  // LIVE INPUT ECHO
  // ------------------
  term.onData(data => {

    // echo locally so characters show up instantly
    term.write(data);

    if(socket.readyState === WebSocket.OPEN){
      socket.send(JSON.stringify({ data }));
    }
  });

  window.addEventListener("resize", () => {
    fitAddon.fit();
  });
</script>

</body>
</html>
